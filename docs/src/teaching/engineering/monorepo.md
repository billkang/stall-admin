# Monorepo 技术介绍

## 一、Monorepo是什么

Monorepo是一种将多个项目的代码存储在一个共享的代码库中的开发模式。与传统的多仓库模式不同，Monorepo将所有相关的项目代码（如多个应用、库、工具等）放在同一个版本控制系统（如Git）的单个仓库中。

## 二、Monorepo技术产生的原因

随着前端工程日益复杂，多个项目之间的代码复用需求、依赖管理复杂性以及团队协作效率低下等问题逐渐显现。传统的多仓库模式在这些场景下显得笨重，而Monorepo通过将多个项目集中管理，解决了以下问题：

1. **代码复用**：不同项目可以共享代码，减少冗余。
2. **依赖管理**：集中管理依赖，避免版本冲突。
3. **协作效率**：减少团队成员在不同仓库之间切换的成本。

## 三、Monorepo解决了什么问题

1. **代码复用**：通过共享代码和模块，提高代码复用率。
2. **依赖管理**：统一管理依赖版本，避免版本冲突。
3. **构建和部署**：简化构建和部署流程，降低维护成本。
4. **团队协作**：提高开发效率，减少协作成本。

## 四、Monorepo适用场景

1. **大型项目**：涉及多个子项目或模块的复杂项目。
2. **多团队协作**：多个团队需要协作开发相关项目。
3. **代码复用需求高**：项目之间有大量的代码共享需求。
4. **依赖管理复杂**：依赖关系复杂，需要统一管理。

## 五、Monorepo不适合的场景

1. **小型项目**：简单的项目使用Monorepo可能增加复杂性。
2. **独立项目**：项目之间没有关联或依赖关系。
3. **权限管理复杂**：需要对不同项目进行精细权限控制。

## 六、Turborepo是什么

Turborepo是一个高性能的构建系统，专为优化Monorepo的工作流程而设计。它通过以下方式解决Monorepo扩展性的问题：

1. **缓存**：通过缓存任务输出，避免重复执行。
2. **增量构建**：精准确定需要重新执行的任务，避免浪费时间。
3. **并行任务处理**：利用多核CPU能力，加速构建过程。
4. **跨项目依赖管理**：直观定义和管理项目之间的依赖关系。

## 七、pnpm是什么

pnpm（Performant npm）是一个高效的包管理工具，旨在解决传统包管理器在依赖安装过程中的性能和磁盘空间占用问题。它通过以下方式实现高效管理：

1. **磁盘空间节省**：通过硬链接和符号链接共享依赖，避免重复存储。
2. **安装速度快**：利用硬链接和并行下载策略，减少磁盘I/O操作。
3. **依赖结构清晰**：采用扁平结构和嵌套结构相结合的方式，避免依赖冲突。
4. **安全性高**：对每个包进行完整性检查，防止恶意代码注入。

## 八、pnpm与npm、Yarn的对比

| 特性 | npm | Yarn | pnpm |
| --- | --- | --- | --- |
| **安装速度** | 较慢（逐个安装） | 较快（并行安装） | 最快（硬链接和并行下载） |
| **磁盘空间占用** | 较大（每个项目独立存储） | 较小（缓存机制） | 最小（共享依赖） |
| **依赖结构** | 扁平化 | 扁平化 | 扁平+嵌套 |
| **安全性** | 基本检查 | 基本检查 | 严格检查 |
| **Monorepo支持** | 有限 | 支持（workspace） | 优秀（内置支持） |

## 九、结合pnpm与Turborepo的项目实践

### 创建Monorepo结构

1. 创建一个新的目录作为Monorepo的根目录，并进入该目录。

   ```bash
   mkdir my-monorepo
   cd my-monorepo
   ```

2. 初始化一个新的`package.json`文件。

   ```bash
   pnpm init -y
   ```

3. 创建`packages`目录，用于存放所有的子项目。

   ```bash
   mkdir packages
   ```

### 配置pnpm工作区

在根目录的`package.json`文件中，添加`workspaces`配置，指定工作区目录。

```json
{
  "name": "my-monorepo",
  "version": "1.0.0",
  "workspaces": [
    "packages/*"
  ]
}
```

### 安装Turborepo

在根目录下安装Turborepo，并创建`turbo.json`配置文件。

```bash
pnpm install turbo -D
```

编辑`turbo.json`文件，定义任务和依赖关系。

```json
{
  "pipeline": {
    "build": {
      "dependsOn": ["^build"],
      "outputs": ["dist/**"]
    }
  }
}
```

### 构建和发布

使用Turborepo运行构建任务：

```bash
turbo run build
```

Turborepo会根据依赖关系图自动安排任务执行，并利用缓存优化流程。

通过结合pnpm和Turborepo，可以实现高效的Monorepo项目管理，提升开发效率和构建速度。这种模式特别适合大型项目和多团队协作场景，能够显著简化依赖管理和构建流程。
